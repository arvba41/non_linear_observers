% This LaTeX was auto-generated from MATLAB code.
% To make changes, update the MATLAB code and export to LaTeX again.

\documentclass{article}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{graphicx}
\usepackage{color}
\usepackage{hyperref}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{epstopdf}
\usepackage[table]{xcolor}
\usepackage{matlab}

\sloppy
\epstopdfsetup{outdir=./}
\graphicspath{ {./le6_code_images/} }

\begin{document}

\begin{matlabcode}
clear; clc; 

%% system definition

x20 = 5;
% states
x = @(t) [x20 * t;...
          x20 ];
% output
yo = @(t) x20 * t; 

% output with noise
yoN = @(t) x20 * t + (rand() - 0.5); % noise with zero average 

%% full-order observer

tspan = [0 5];
xh10 = [0; 0];
[t1, x1] = ode45(@(t,y) full_order(y, yo(t)), tspan, xh10);

%% full-order with noise

[t1N, x1N] = ode45(@(t,y) full_order(y, yoN(t)), tspan, xh10);

%% reduced-order observer

mass = [1 0 0;...v
        0 0 0;...
        0 0 0]; % mass matrix
ode_opts = odeset('Mass',mass); 
xvec0 = [1; -3; 4];
[t2, x2] = ode15s(@(t,y) r_obs(y, yo(t)), tspan, xvec0, ode_opts);

%% reduced-order observer with noise

xvec0 = x2(1,:);
[t2N, x2N] = ode15s(@(t,y) r_obs(y, yoN(t)), tspan, xvec0, ode_opts);

%% plots

figure(1); clf; 

% true states
xv1 = @(t) x20 * t; 
xv2 = @(t) x20 + 0*t; 
xt1 = xv1(t1);
xt2 = xv2(t1);
xt1N = xv1(t1N);
xt2N = xv2(t1N);
xtt1 = xv1(t2);
xtt2 = xv2(t2);
xtt1N = xv1(t2N);
xtt2N = xv2(t2N);

subplot(221)
yyaxis left
plot(t1,[xt1, x1(:,1)]); box off;
ylabel('$x_1$','Interpreter','latex')
yyaxis right
plot(t1,[xt2, x1(:,2)]); box off;
ylabel('$x_2$','Interpreter','latex')
xlabel('$t$ [s]','Interpreter','latex')
title('full','Interpreter','latex')

subplot(222)
yyaxis left
plot(t1N,[xt1N, x1N(:,1)]); box off;
ylabel('$x_1$','Interpreter','latex')
yyaxis right 
plot(t1N,[xt2N, x1N(:,2)]); box off;
ylabel('$x_2$','Interpreter','latex')
xlabel('$t$ [s]','Interpreter','latex')
title('full (noise)','Interpreter','latex')

subplot(223)
yyaxis left
plot(t2,[xtt1, x2(:,2)]); box off;
ylabel('$x_1$','Interpreter','latex')
yyaxis right
plot(t2,[xtt2, x2(:,3)]); box off;
ylabel('$x_2$','Interpreter','latex')
xlabel('$t$ [s]','Interpreter','latex')
title('reduced','Interpreter','latex')
legend('$x$','$\hat x$')
legend('Interpreter','latex');

subplot(224)
yyaxis left
plot(t2N,[xtt1N, x2N(:,2)]); box off;
ylabel('$x_1$','Interpreter','latex')
yyaxis right
plot(t2N,[xtt2N, x2N(:,3)]); box off;
ylabel('$x_2$','Interpreter','latex')
xlabel('$t$ [s]','Interpreter','latex')
title('reduced (noise)','Interpreter','latex')

% saving plots
textwidth = 14.9;
golden_ratio = (1 + sqrt(5)) / 2;
textheight = textwidth / golden_ratio;
figsize = [textwidth, textheight];

% Get latex font in ticks
h = findall(gcf,'Type','axes'); % An array if you have subplots
set(h, 'TickLabelInterpreter', 'latex')

% Set size and no crop
set(gcf, 'PaperUnits', 'centimeters', 'PaperSize', figsize);
set(gcf, 'PaperUnits', 'normalized', 'PaperPosition', [0, 0, 1, 1]);

print -dpdf ../doc/figures/ex6.pdf

%% function

\end{matlabcode}


\begin{matlabcode}
function xdot = full_order(x,y) 

%%% initialization 
    xdot = zeros(2,1);
   
%%% state equations
    A = [0, 1;...
         0, 0];
    
    K = 5;
    
    xdot = A * x + K * (y - x(1));
    
end

function xdot = r_obs(x,y) 

%%% initialization 
    % x(1) = w
    % x(2) = x1
    % x(3) = x2

    xdot = zeros(3,1);
    % xdot(1) = dot w
    % xdot(2) = 0 = y - x(2)
    % xdot(3) = 0 = x(3) - (x(1) + Ky) 
    
%%% state equations
    
    K = 5; %% same K as before
    
    xdot(1) = - K * x(1) - K * K * y;
    xdot(2) = y - x(2);
    xdot(3) = x(1) + K * y - x(3);
    
end


\end{matlabcode}

\end{document}
